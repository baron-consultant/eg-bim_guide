---
import { getSidebarTabs } from '../lib/sidebarConfig';
import SearchBar from './SearchBar.astro';

const {activeMenu } = Astro.props;

const sidebarTabs = await getSidebarTabs();

const isActive = (id: string) => activeMenu === id || activeMenu.includes(id);

// í˜„ì¬ í™œì„± íƒ­ ê²°ì • (activeMenuê°€ ì†í•œ íƒ­)
function getActiveTab() {
  // 1ï¸âƒ£ activeMenu ê¸°ë°˜ìœ¼ë¡œ íƒ­ ì°¾ê¸°
  for (const tab of sidebarTabs) {
    for (const group of tab.groups) {
      for (const item of group.items) {
        if (isActive(item.id)) return tab.id;
        if (item.children) {
          for (const child of item.children) {
            if (isActive(child.id)) return tab.id;
          }
        }
      }
    }
  }
  
  // 2ï¸âƒ£ Astro.urlì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘ì—ì„œ URL ê¸°ë°˜ íƒ­ ê²°ì •
  const currentPath = Astro.url.pathname;
  if (currentPath.includes('/ko/commands/')) {
    return 'commands';
  }
  
  // 3ï¸âƒ£ activeMenu ë¬¸ìì—´ë¡œ íŒë‹¨
  if (activeMenu && activeMenu.includes('commands')) {
    return 'commands';
  }
  
  return sidebarTabs[0]?.id || 'grimmi';
}

const activeTab = getActiveTab();

// ê° íƒ­ì˜ ì²« ë²ˆì§¸ ë§í¬ ì°¾ê¸° í•¨ìˆ˜
function getFirstLinkForTab(tab: any): string {
  for (const group of tab.groups) {
    for (const item of group.items) {
      // ì§ì ‘ ë§í¬ê°€ ìˆëŠ” ê²½ìš°
      if (item.href) return item.href;
      
      // ìì‹ì´ ìˆëŠ” ê²½ìš° ì²« ë²ˆì§¸ ìì‹ì˜ ë§í¬
      if (item.children && item.children.length > 0) {
        const firstChild = item.children[0];
        if (firstChild.href) return firstChild.href;
        
        // ì†ìê°€ ìˆëŠ” ê²½ìš°
        if (firstChild.children && firstChild.children.length > 0) {
          return firstChild.children[0].href;
        }
      }
    }
  }
  return '#';
}
---
<div class="lnb-container">
  <!-- íƒ­ ë©”ë‰´ -->
  <div class="sidebar-wrap">
    <div class="sidebar-tabs">
      {sidebarTabs.map(tab => (
        <button 
          class={`tab-button ${activeTab === tab.id ? 'active' : ''}`}
          data-tab={tab.id}
          data-tab-link={getFirstLinkForTab(tab)}
        >
          {tab.icon && <i class={tab.icon}></i>}
          <span>{tab.label}</span>
        </button>
      ))}
    </div>
    
    <!-- SearchBarë¥¼ sidebar-tabs ì•„ë˜ë¡œ ì´ë™ (Bíƒ­ì¼ ë•Œë§Œ í‘œì‹œ) -->
    <div class="searchbar-wrapper" data-show-on-tab="commands" >
      <SearchBar />
    </div>
  </div>

  <!-- íƒ­ ì»¨í…ì¸  -->
  {sidebarTabs.map(tab => (
    <div 
      class={`tab-content ${activeTab === tab.id ? 'active' : ''} ${tab.id === 'commands' ? 'grid-layout' : ''}`}
      data-tab-content={tab.id}
    >
      {tab.groups.map((group, groupIdx) => (
        <div class="nav-group">
          <div class="group-tit">
            <h2><i class={group.icon}></i>{group.title}</h2>
          </div>

          <ul class="depth01">
            {group.items.map((item, idx) => {
              const menuId = `${tab.id}_menuGroup${String(groupIdx * 10 + idx + 1).padStart(2, '0')}`;
              
              // ğŸ”¹ ë¼ë²¨ì´ ì—†ìœ¼ë©´ singleë¡œ ì²˜ë¦¬
              const isSingleItem = item.children && !item.label;
              
              return (
                <li class={isActive(item.id) ? 'active' : ''}>
                  {item.children ? (
                    <>
                      {/* ğŸ”¹ singleì¸ ê²½ìš° depth01 > li > a ì—†ì´ ë°”ë¡œ depth02 */}
                      {!isSingleItem && (
                        <a href="#" data-toggle={menuId}>
                          <i class="ico-arrow"></i>
                          <span>{item.label}</span>
                        </a>
                      )}
                      
                      <ul class={`depth02 ${isSingleItem ? 'single' : (isActive(item.id) ? '' : 'd-none')}`} id={menuId}>
                        {item.children.map((child) => (
                          <li class={isActive(child.id) ? 'active' : ''}>
                            <a href={child.href || '#'} data-page={child.id}>
                              <span>{child.label}</span>
                            </a>
                            
                            {child.children && (
                              <ul class="depth03">
                                {child.children.map((grandChild) => (
                                  <li class={isActive(grandChild.id) ? 'active' : ''}>
                                    <a href={grandChild.href} data-page={grandChild.id}>
                                      <span>{grandChild.label}</span>
                                    </a>
                                  </li>
                                ))}
                              </ul>
                            )}
                          </li>
                        ))}
                      </ul>
                    </>
                  ) : (
                    <ul class="depth02 single">
                      <li class={isActive(item.id) ? 'active' : ''}>
                        <a href={item.href} data-page={item.id}>
                          <span>{item.label}</span>
                        </a>
                      </li>
                    </ul>
                  )}
                </li>
              );
            })}
          </ul>
        </div>
      ))}
    </div>
  ))}
</div>

<script>
import { navigate } from 'astro:transitions/client';

/* ------------------------------
  ì‚¬ì´ë“œë°” ìŠ¤í¬ë¡¤ ìƒíƒœ ì €ì¥
------------------------------ */
function saveSidebarScroll() {
  const sidebar = document.querySelector('.nav-wrap');
  if (!sidebar) return;

  const activeTabBtn = document.querySelector('.sidebar-tabs .tab-button.active');
  const tabId = activeTabBtn?.dataset.tab || 'default';

  sessionStorage.setItem(`scroll_${tabId}`, sidebar.scrollTop);
}

/* ------------------------------
  ì‚¬ì´ë“œë°” ìŠ¤í¬ë¡¤ ë³µì›
------------------------------ */
function restoreSidebarScroll() {
  const sidebar = document.querySelector('.nav-wrap');
  if (!sidebar) return;

  const activeTabBtn = document.querySelector('.sidebar-tabs .tab-button.active');
  const tabId = activeTabBtn?.dataset.tab || 'default';

  const savedScroll = sessionStorage.getItem(`scroll_${tabId}`);
  if (savedScroll) {
    sidebar.scrollTop = parseFloat(savedScroll);
  }
}
  /* ------------------------------
    ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ì‹œì¼œì£¼ëŠ” í•¨ìˆ˜
  ------------------------------ */
function scrollActiveDepth02IntoView() {
  const sidebar = document.querySelector('.nav-wrap');
  if (!sidebar) return;

  const activeItem = sidebar.querySelector('.depth02 > li.active, .depth03 > li.active');
  if (!activeItem) return;

  const sidebarRect = sidebar.getBoundingClientRect();
  const itemRect = activeItem.getBoundingClientRect();
  const visibleHeight = sidebar.clientHeight;

  const targetScroll =
    activeItem.offsetTop - visibleHeight / 2 + activeItem.offsetHeight / 2;

  // í•˜ë‹¨ ê¸°ì¤€ê°’ (í˜„ì¬ ìŠ¤í¬ë¡¤ ì˜ì—­ì˜ bottom - 160px)
  const thresholdBottom = sidebarRect.bottom - 160;
const thresholdTop = sidebarRect.top + 280; // ìƒë‹¨ ì—¬ìœ  280px
if (itemRect.top < thresholdTop || itemRect.bottom > thresholdBottom) {
  sidebar.scrollTo({
    top: targetScroll,
    behavior: 'smooth',
  });
}
}

/* ------------------------------
  ì‚¬ì´ë“œë°” ì´ˆê¸°í™” í•¨ìˆ˜
------------------------------ */
function initializeSidebar() {
  const tabButtons = document.querySelectorAll('.sidebar-tabs .tab-button'); 
  const tabContents = document.querySelectorAll('.tab-content');
  const searchbarWrapper = document.querySelector('.searchbar-wrapper');

  let isNavigating = false;

  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* ------------------------------
    URL ê¸°ë°˜ ì´ˆê¸° íƒ­ í™œì„±í™”
  ------------------------------ */
  function setInitialTab() {
    const path = window.location.pathname;
    let activeTabId = path.includes('/ko/commands/') ? 'commands' : tabButtons[0]?.dataset.tab || 'grimmi';
    activateTab(activeTabId);
  }
  
  /* ------------------------------
    íƒ­ í™œì„±í™” ê³µí†µ í•¨ìˆ˜
  ------------------------------ */
  function activateTab(tabId) {
    tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
    tabContents.forEach(content => content.classList.toggle('active', content.dataset.tabContent === tabId));

    if (searchbarWrapper) {
      searchbarWrapper.style.display = searchbarWrapper.dataset.showOnTab === tabId ? 'block' : 'none';
    }
  }

  /* ------------------------------
    ë§í¬ í´ë¦­ ì‹œ depth ë©”ë‰´ í™œì„±í™”
  ------------------------------ */
function activateDepthMenu(targetPath) {
  const activeTabContent = $('.tab-content.active');
  const isGridLayout = activeTabContent?.classList.contains('grid-layout');

  // ğŸ”¹ ëª¨ë“  ë©”ë‰´ ì´ˆê¸°í™”
  $$('.depth01 > li').forEach(li => li.classList.remove('active'));
  $$('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
  $$(`.depth02 li, .depth03 li`).forEach(li => li.classList.remove('active'));

  // ğŸ”¹ í´ë¦­ëœ ë©”ë‰´ë§Œ í™œì„±í™”
  const targetAnchor = $$(`a[href]`).find(a => new URL(a.href, location.origin).pathname === targetPath);
  if (!targetAnchor) return;

  const parentLi = targetAnchor.closest('.depth01 > li');
  const parentDepth02 = targetAnchor.closest('.depth02');

  // B íƒ­(=grid-layout)ì¸ ê²½ìš° â†’ ë‚˜ë¨¸ì§€ ì „ë¶€ ë‹«ê³  í´ë¦­í•œ ë©”ë‰´ë§Œ ì—´ê¸°
  if (isGridLayout) {
    // ëª¨ë“  depth02 ë‹«ê¸°
    $$('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
    // í´ë¦­í•œ depth02ë§Œ ì—´ê¸°
    if (parentDepth02) parentDepth02.classList.remove('d-none');
    if (parentLi) parentLi.classList.add('active');
  } else {
    // ì¼ë°˜ íƒ­ì€ ê¸°ì¡´ì²˜ëŸ¼ í™œì„±í™”ë§Œ ì²˜ë¦¬
    if (parentLi) parentLi.classList.add('active');
    if (parentDepth02) parentDepth02.classList.remove('d-none');
  }

  // ğŸ”¹ í™œì„± í‘œì‹œ
  targetAnchor.parentElement?.classList.add('active');
}

  
  /* ------------------------------
    íƒ­ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
  ------------------------------ */
  tabButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      if (isNavigating || this.classList.contains('active')) return;

      const tabId = this.dataset.tab;
      const defaultLink = this.dataset.tabLink || '#';
      const lastVisited = sessionStorage.getItem(`lastVisited_${tabId}`) || defaultLink;

      activateTab(tabId);
      activateDepthMenu(lastVisited);

      isNavigating = true;
      requestAnimationFrame(() => {
        navigate(lastVisited).finally(() => isNavigating = false);
      });
    });
  });


  /* ------------------------------
    depth ë©”ë‰´ í† ê¸€
  ------------------------------ */
  $$('.depth01 > li > a[data-toggle]').forEach(menu => {
    const newMenu = menu.cloneNode(true);
    menu.parentNode?.replaceChild(newMenu, menu);

    newMenu.addEventListener('click', function(e) {
      e.preventDefault();
      const parentLi = this.parentElement;
      const toggleId = this.getAttribute('data-toggle');
      const depth02 = toggleId ? document.getElementById(toggleId) : null;

      if (depth02 && !depth02.classList.contains('single')) {
        const activeTabContent = $('.tab-content.active');
        const isGridLayout = activeTabContent?.classList.contains('grid-layout');

        if (isGridLayout) {
          // ğŸ”¹ Bíƒ­ì¼ ê²½ìš°: ëª¨ë“  ë©”ë‰´ ë‹«ê³  í´ë¦­í•œ ë©”ë‰´ë§Œ ì—´ê¸°
          $$('.depth01 > li').forEach(li => li.classList.remove('active'));
          $$('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));
          parentLi.classList.add('active');
          depth02.classList.remove('d-none');
        } else {
          // ğŸ”¹ ì¼ë°˜ íƒ­ì€ ê¸°ì¡´ì²˜ëŸ¼ í† ê¸€
          depth02.classList.toggle('d-none');
          parentLi?.classList.toggle('active');
        }
      }
    });

  });


  /* ------------------------------
    ë§í¬ í´ë¦­ ì‹œ lastVisited ì €ì¥
  ------------------------------ */
$$('.depth02 a, .depth03 a').forEach(link => {
  link.addEventListener('click', function(e) {
    const href = this.getAttribute('href');
    if (!href || href === '#') {
      e.preventDefault();
      return;
    }

    // âœ… í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
    saveSidebarScroll();

    const activeTabBtn = $('.sidebar-tabs .tab-button.active');
    if (activeTabBtn) {
      sessionStorage.setItem(
        `lastVisited_${activeTabBtn.dataset.tab}`,
        new URL(href, location.origin).pathname
      );
    }

    activateDepthMenu(new URL(href, location.origin).pathname);
  });
});


  // ì´ˆê¸° íƒ­ ì„¤ì • ì‹¤í–‰
  setInitialTab();
}



initializeSidebar();
document.addEventListener('astro:page-load', () => {
  initializeSidebar();
  restoreSidebarScroll();         // ì´ì „ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
  setTimeout(() => {
    scrollActiveDepth02IntoView(); // ì„ íƒëœ ë©”ë‰´ ì¤‘ì•™ ë°°ì¹˜
  }, 100); // ì‚´ì§ ì§€ì—°ì„ ì¤˜ì•¼ DOM ìœ„ì¹˜ê°€ ì¡íŒ í›„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ë™ë¨
});

/* ------------------------------
  ğŸ”™ ë’¤ë¡œê°€ê¸°(popstate) ì²˜ë¦¬
------------------------------ */
/* ------------------------------
  ğŸ”™ ë’¤ë¡œê°€ê¸°(popstate) ì²˜ë¦¬ + ë¶€ë“œëŸ¬ìš´ ë‹«í˜ + ìŠ¤í¬ë¡¤ ë³µì›
------------------------------ */
window.addEventListener('popstate', () => {
  const currentPath = window.location.pathname;
  const sidebar = document.querySelector('.nav-wrap');
  const activeTabContent = document.querySelector('.tab-content.active');
  const isGridLayout = activeTabContent?.classList.contains('grid-layout');

  // ğŸ”¹ ìŠ¤í¬ë¡¤ ë³µì›
  restoreSidebarScroll();

  // ğŸ”¹ í˜„ì¬ ë©”ë‰´ ì°¾ê¸°
  const currentAnchor = [...document.querySelectorAll('a[href]')].find(a =>
    new URL(a.href, location.origin).pathname === currentPath
  );
  if (!currentAnchor) return;

  // ğŸ”¹ depth ì´ˆê¸°í™” + ë¶€ë“œëŸ½ê²Œ ë‹«ê¸°
  document.querySelectorAll('.depth01 > li.active').forEach(li => li.classList.remove('active'));
  document.querySelectorAll('.depth02:not(.single)').forEach(ul => {
    if (!ul.classList.contains('d-none')) {
       ul.classList.add('d-none');
    }
  });

  // ğŸ”¹ í˜„ì¬ ë©”ë‰´ë§Œ ì—´ê¸°
  const parentLi = currentAnchor.closest('.depth01 > li');
  const parentDepth02 = currentAnchor.closest('.depth02');

  if (isGridLayout) {
    // commands íƒ­ì¼ ê²½ìš°: ë‚˜ë¨¸ì§€ ì „ë¶€ ë‹«ê³  í´ë¦­í•œ depth02ë§Œ ì—´ê¸°
    document.querySelectorAll('.depth01 > li').forEach(li => li.classList.remove('active'));
    document.querySelectorAll('.depth02:not(.single)').forEach(depth => depth.classList.add('d-none'));

    parentLi?.classList.add('active');
    parentDepth02?.classList.remove('d-none');
  } else {
    // ì¼ë°˜ íƒ­ì´ë©´ ë‹¨ìˆœíˆ ì—´ê¸°
    parentLi?.classList.add('active');
    parentDepth02?.classList.remove('d-none');
  }

  currentAnchor.parentElement?.classList.add('active');

  // ğŸ”¹ í™œì„± ë©”ë‰´ ì¤‘ì•™ ë°°ì¹˜
  setTimeout(scrollActiveDepth02IntoView, 400);
});


</script>
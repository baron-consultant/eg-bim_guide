---
import BaseLayout from './_HelpLayout.astro';
import { pageRoutes, defaultPage } from '../../lib/navigation.js';
import { loadComponent } from '../../lib/componentLoader.js';
import { getCollection , getEntry, render} from 'astro:content';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const componentRoutes = pageRoutes.map(route => ({
    params: { slug: route.slug },
    props: { type: 'component', route },
  }));

  const docsEntries = await getCollection('docs', e => e.id.startsWith('ko/commands/'));

  docsEntries.sort((a, b) => {
    const pathA = a.id.toLowerCase();
    const pathB = b.id.toLowerCase();
    return pathA.localeCompare(pathB, 'en', { numeric: true, sensitivity: 'base' });
  });

  const docsRoutes = docsEntries.map(entry => {
    const slug = entry.id.replace(/\.mdx?$/, '');
    return {
      params: { slug },
      props: {
        type: 'mdx',
        entrySlug: slug,
        entryData: entry.data,
      },
    };
  });

  return [
    { params: { slug: undefined }, props: { type: 'component', route: defaultPage } },
    ...componentRoutes,
    ...docsRoutes,
  ];
}

const { type, route, entrySlug, entryData } = Astro.props;
let pageTitle, activeMenu, Component, htmlContent;
let pageClass = '';

const CustomImage = (props: any) => {
  const { src, alt = '', width, height, ...rest } = props;
  const imgSrc = typeof src === 'object' && src.src ? src.src : src;
  const imgWidth = width || (typeof src === 'object' && src.width ? src.width : undefined);
  const imgHeight = height || (typeof src === 'object' && src.height ? src.height : undefined);
  return { tag: 'img', props: { src: imgSrc, alt, width: imgWidth, height: imgHeight, ...rest } };
};

if (type === 'mdx') {
  pageTitle = entryData.title || entrySlug;
  activeMenu = entrySlug;
  pageClass = entrySlug.replace(/^ko\//, '').replace(/\//g, '-').replace(/[^a-z0-9-]/gi, '-').toLowerCase();

  try {

    const allDocs = await getCollection('docs');
    const entry = allDocs.find(doc => doc.id.replace(/\.mdx?$/, '') === entrySlug);

    if (!entry) throw new Error(`Entry not found in collection: ${entrySlug}`);

    const { Content } = await render(entry);
    Component = Content;
  } catch (error) {
    htmlContent = `<div class="error"><h2>Failed to load content</h2><p>${error.message}</p></div>`;
  }
} else {
  const current = route || defaultPage;
  Component = await loadComponent(current.path);
  pageTitle = current.title;
  activeMenu = current.slug;
  pageClass = current.slug.replace(/\//g, '-').toLowerCase();
}

// ✅ 타입별 콘텐츠 래퍼 클래스 지정
const contentClass = type === 'mdx' ? 'sl-markdown-content' : 'markdown-content';

const fullTitle = type === 'mdx' ? `명령어-${pageTitle}` : pageTitle;
---

<BaseLayout title={fullTitle} activeMenu={activeMenu} showBackButton={type !== 'markdown'} pageClass={pageClass}>
  <div class={contentClass}>
       <!-- ✅ pageTitle은 MDX일 때만 표시 -->
    {type === 'mdx' && pageTitle && <h1 class="page-title">{pageTitle}</h1>}
    {Component ? (
      <Component components={{ Image: CustomImage }} />
    ) : (
      <div set:html={htmlContent} />
    )}
  </div>
</BaseLayout>
